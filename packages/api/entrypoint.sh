#!/usr/bin/env sh

# http://redsymbol.net/articles/unofficial-bash-strict-mode/
set -euo pipefail

echo '
-------------------------------------------------------------------------------------------------------------------

 ██████╗███████╗███╗   ██╗████████╗██████╗  █████╗ ██╗   ██╗███████╗██████╗ ███████╗███████╗     █████╗ ██████╗ ██╗
██╔════╝██╔════╝████╗  ██║╚══██╔══╝██╔══██╗██╔══██╗██║   ██║██╔════╝██╔══██╗██╔════╝██╔════╝    ██╔══██╗██╔══██╗██║
██║     █████╗  ██╔██╗ ██║   ██║   ██████╔╝███████║██║   ██║█████╗  ██████╔╝███████╗█████╗      ███████║██████╔╝██║
██║     ██╔══╝  ██║╚██╗██║   ██║   ██╔══██╗██╔══██║╚██╗ ██╔╝██╔══╝  ██╔══██╗╚════██║██╔══╝      ██╔══██║██╔═══╝ ██║
╚██████╗███████╗██║ ╚████║   ██║   ██║  ██║██║  ██║ ╚████╔╝ ███████╗██║  ██║███████║███████╗    ██║  ██║██║     ██║
 ╚═════╝╚══════╝╚═╝  ╚═══╝   ╚═╝   ╚═╝  ╚═╝╚═╝  ╚═╝  ╚═══╝  ╚══════╝╚═╝  ╚═╝╚══════╝╚══════╝    ╚═╝  ╚═╝╚═╝     ╚═╝                                                                                                         

-------------------------------------------------------------------------------------------------------------------
'
yarn prisma generate
if [[ "${NODE_ENV}" == "staging" ]]; then
	echo 'Running in staging environment: will reset database in 30 seconds...'
	sleep 30
	yarn add tsx
	yarn prisma migrate reset --force
else
	echo 'Running migrations...'
	yarn prisma migrate deploy
fi;
echo 'Migrated!'


echo 'Starting centraverse api...'
yarn workspace @centraverse/api start
